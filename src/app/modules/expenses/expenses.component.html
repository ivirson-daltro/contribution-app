<div class="expenses container-fluid py-4">
  <div class="row align-items-center mb-4">
    <div class="col-12 col-lg">
      <h1 class="h4 mb-1 fw-semibold">Despesas</h1>
      <p class="text-muted small mb-0">Visualize e gerencie todas as despesas</p>
    </div>
    <div class="col-12 col-lg-auto">
      @if (user?.role === userRoles.ADMIN || user?.role === userRoles.TREASURER) {
        <button type="button" class="btn btn-primary submit-button" (click)="openNewExpense()">
          <mat-icon fontIcon="add" class="submit-icon"></mat-icon> Nova despesa
        </button>
      }
    </div>
  </div>

  <!-- Filtros -->
  <div class="col-12 mb-4">
    <mat-card class="panel h-100">
      <h2 class="panel-title mb-3 d-flex align-items-center">
        <mat-icon fontIcon="filter_alt" class="me-2"></mat-icon> Filtros
      </h2>
      <div class="row mb-2">
        <div class="col-12 col-lg mb-3">
          <label for="categoryId" class="form-label">Categoria</label>
          <select class="form-control" [(ngModel)]="categoryId">
            <option [value]="null" disabled selected>- Selecione</option>
            @for ((category of categories$ | async); track $index) {
              <option [value]="category.id">{{ category.description }}</option>
            }
          </select>
        </div>

        <div class="col-12 col-lg mb-3">
          <label for="startDate" class="form-label">Data inicial</label>
          <input type="date" class="form-control" [(ngModel)]="startDate" />
        </div>

        <div class="col-12 col-lg mb-3">
          <label for="endDate" class="form-label">Data Final</label>
          <input type="date" class="form-control" [(ngModel)]="endDate" />
        </div>
      </div>

      <div class="row justify-content-between">
        <div class="col-12 col-lg-4">
          @if (user?.role === userRoles.ADMIN || user?.role === userRoles.TREASURER) {
            <button
              type="button"
              class="btn btn-primary submit-button btn-print"
              (click)="getMonthlyReport()"
            >
              <mat-icon fontIcon="print" class="submit-icon"></mat-icon> Imprimir Relatório de
              despesas do mês
            </button>
          }
        </div>
        <div class="col-12 col-lg-4 text-end">
          <button type="button" class="btn cancel-button" (click)="limpar()">
            <mat-icon fontIcon="clear" class="submit-icon"></mat-icon> Limpar
          </button>
          <button type="submit" class="btn btn-primary submit-button" (click)="loadExpenses()">
            <mat-icon fontIcon="search" class="submit-icon"></mat-icon> Pesquisar
          </button>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Grid -->
  <div class="col-12 mb-4">
    <mat-card class="panel h-100">
      <h2 class="panel-title mb-3">Despesas</h2>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th (click)="changeSort('date')" class="sortable text-center">
                Data
                @if (sortBy === 'date') {
                  <mat-icon
                    class="sort-icon"
                    fontIcon="{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}"
                  ></mat-icon>
                }
              </th>
              <th (click)="changeSort('value')" class="sortable text-center">
                Valor
                @if (sortBy === 'value') {
                  <mat-icon
                    class="sort-icon"
                    fontIcon="{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}"
                  ></mat-icon>
                }
              </th>
              <th (click)="changeSort('categoryId')" class="sortable text-center">
                Categoria
                @if (sortBy === 'categoryId') {
                  <mat-icon
                    class="sort-icon"
                    fontIcon="{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}"
                  ></mat-icon>
                }
              </th>
              <th class="text-center">Descrição</th>
              <th class="text-center">Anexo</th>
              <th class="text-center">Observações</th>
              @if (user?.role === userRoles.ADMIN || user?.role === userRoles.TREASURER) {
                <th class="text-center">Ações</th>
              }
            </tr>
          </thead>
          <tbody>
            @if (expenses.length === 0) {
              <tr>
                <td colspan="6" class="text-center text-muted small py-4">
                  Nenhuma despesa encontrada.
                </td>
              </tr>
            } @else {
              @for (item of expenses; track item.id) {
                <tr>
                  <td class="text-center">{{ item.date | date: 'shortDate' : 'pt-BR' }}</td>
                  <td class="text-center">
                    {{
                      utilsService.normalizeAmount(item.value)
                        | currency: 'BRL' : 'symbol' : '1.2-2' : 'pt-BR'
                    }}
                  </td>
                  <td class="text-center">{{ item.category.description }}</td>
                  <td class="text-center">{{ item.description }}</td>
                  <td class="d-flex justify-content-center">
                    @if (item.attachmentUrl) {
                      <a
                        href="#"
                        (click)="downloadAttachment(item.attachmentUrl); $event.preventDefault()"
                        class="attachment-link"
                      >
                        <mat-icon fontIcon="attach_file"></mat-icon>
                      </a>
                    } @else {
                      <span class="text-muted py-2">-</span>
                    }
                  </td>
                  <td class="text-center">{{ item.notes }}</td>
                  @if (user?.role === userRoles.ADMIN || user?.role === userRoles.TREASURER) {
                    <td class="text-center">
                      <button
                        class="rounded-button me-1"
                        aria-label="Editar Despesa"
                        (click)="editExpense(item)"
                      >
                        <mat-icon fontIcon="edit"></mat-icon>
                      </button>

                      <button
                        class="rounded-button"
                        aria-label="Excluir Despesa"
                        (click)="deleteExpense(item.id)"
                      >
                        <mat-icon fontIcon="delete"></mat-icon>
                      </button>
                    </td>
                  }
                </tr>
              }
            }
          </tbody>
        </table>
      </div>

      <div class="row">
        <div class="col-12 col-lg-6">
          <p class="me-5 mb-3 mt-4"><strong>Total de despesas:</strong> {{ totalExpenses }}</p>
        </div>
        <div class="col-12 col-lg-6">
          @if (totalPages > 1) {
            <nav class="mt-3">
              <ul class="pagination justify-content-end align-items-center mb-0">
                <li class="page-item" [class.disabled]="pageIndex === 0">
                  <button
                    class="page-link"
                    type="button"
                    (click)="goToPage(pageIndex - 1)"
                    [disabled]="pageIndex === 0"
                  >
                    Anterior
                  </button>
                </li>

                @for (page of pages; track page) {
                  <li class="page-item" [class.active]="pageIndex === page">
                    <button class="page-link" type="button" (click)="goToPage(page)">
                      {{ page + 1 }}
                    </button>
                  </li>
                }

                <li class="page-item" [class.disabled]="pageIndex >= totalPages - 1">
                  <button
                    class="page-link"
                    type="button"
                    (click)="goToPage(pageIndex + 1)"
                    [disabled]="pageIndex >= totalPages - 1"
                  >
                    Próxima
                  </button>
                </li>
              </ul>
            </nav>
          }
        </div>
      </div>
    </mat-card>
  </div>
</div>
